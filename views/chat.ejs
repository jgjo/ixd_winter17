<!DOCTYPE html>
<html >
<head>
    <% include ../views/partials/head %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">

    <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Open+Sans'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.min.css'>

    <link rel="stylesheet" href="stylesheets/chat.css">

    <style>
     div.vertical-line{
      width: 1px; 
      background-color: black; 
      height: 100%; 
      float: left; 
      }
    </style>
  
</head>

<body>
    <header>
        <% include ../views/partials/header %>
    </header>

    <div class="chat">
      <div id="userdiv"class="chat-title" style="background-color: #f5f5f5">
        <figure class="avatar">
          <img src="images/otherUser.png" />
        </figure>
      </div>
      <div class="messages" style="background-color: #f5f5f5">
        <div class="messages-content"></div>
      </div>
      <div class="message-box" style="background-color: #f5f5f5">
        <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
        <button type="submit" class="message-submit"><i class="material-icons" style="color:grey">send</i></button>
      </div>
    </div>
    <div class="bg" style="background-color: #f5f5f5;"></div>

    <div id="exitbtndiv" class="exitButton" style="text-align: center; background-color:#3f63a1">
            <a id="goingbtn" href="/logexperience">
              <button class="mdl-button mdl-js-button" style="width:49%; color:#f5f5f5">
                We're going!
              </button>
            </a>

            

            <a onclick="btn2()">
            <button class="mdl-button mdl-js-button" style="width:49%; color:#f5f5f5; height: 100%; border-left: white; border-left-style: solid;">
              It didn't work out
            </button>
          </a>     
    </div>


    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js'></script>-->

    <script>
        var $messages = $('.messages-content'),
            d, h, m,
            i = 0;

        $(window).load(function() {
          $messages.mCustomScrollbar();
          // setTimeout(function() {
          //   fakeMessage();
          // }, 10);
        });

        function updateScrollbar() {
          $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
            scrollInertia: 10,
            timeout: 0
          });
        }

        function setDate(){
          d = new Date()
          if (m != d.getMinutes()) {
            m = d.getMinutes();
            $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
          }
        }

        function insertMessage() {
          msg = $('.message-input').val();
          if ($.trim(msg) == '') {
            return false;
          }
          $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
          setDate();
          $('.message-input').val(null);
          updateScrollbar();
          setTimeout(function() {
            fakeMessage();
          }, 100 + (Math.random() * 20) * 100);
        }

        $('.message-submit').click(function() {
          insertMessage();
        });

        $(window).on('keydown', function(e) {
          if (e.which == 13) {
            insertMessage();
            return false;
          }
        })

        var Fake = [
          'Hi!',
          'Nice to meet you',
          'How are you?',
          'That\'s awesome',
          'Hi!',
          'See you soon',
          'Let\'s meet in 20 minutes',
          'Bye',
          ':)'
        ]

        function fakeMessage() {
          if ($('.message-input').val() != '') {
            return false;
          }
          $('<div class="message loading new"><figure class="avatar"><img src="images/otherUser.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
          updateScrollbar();

          var i = Math.floor(Math.random() * (8));
          setTimeout(function() {
            $('.message.loading').remove();
            $('<div class="message new"><figure class="avatar"><img src="images/otherUser.png" /></figure>' + Fake[i] + '</div>').appendTo($('.mCSB_container')).addClass('new');
            setDate();
            updateScrollbar();
          }, 100 + (Math.random() * 20) * 100);

        }

        function historyHostMessage(message) {
          $('<div class="message new"><figure class="avatar"><img src="images/otherUser.png" /></figure>' + message + '</div>').appendTo($('.mCSB_container')).addClass('new');
          setDate();
          updateScrollbar();
        }

        function historyOwnMessage(message) {
          msg = message;
          $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
          setDate();
          $('.message-input').val(null);
          updateScrollbar();
          setTimeout(function() {
            fakeMessage();
          }, 100 + (Math.random() * 20) * 100);
        }


          var urlParams = new URLSearchParams(window.location.search);
          id = urlParams.get('id');
          if(id==null)
          {
            console.log("null");
          }
          hostid = urlParams.get('hostid');
          var goBack = function()
          {
            window.location.href = '/activity?id='+id
          }

          var btn1 = function() 
          {
            window.location.href = '/logexperience'
          }

          var btn2 = function() 
          {
            window.alert("Activity cancelled");
            window.location.href = '/'
          }

          var activities =<%-JSON.stringify(activitiesJSON)%>
          var users =<%-JSON.stringify(usersJSON)%>
          var activity;   
          var host;
          for(var i=0; i<activities.activities.length; i++) {
              if(activities.activities[i].id == id)
              {
                  activity = activities.activities[i];
              }
          }
          for(var i=0; i<users.users.length; i++) {
              if(users.users[i].id == hostid)
              {
                  host = users.users[i];
              }
          }

          var populatePage_hostName = function(){
              var parent = document.getElementById("userdiv");
              var newdiv = document.createElement("h1");
              newdiv.innerHTML = activity.hostName;
              newdiv.style = "padding-top: 8px;";
              parent.append(newdiv);              
          }

          var updateRedirect = function()
          {
            document.getElementById("goingbtn").href="/logexperience?id="+activity.id;
          }

          var populateprevmessages = function()
          {
            messageHistory = host.chatMessages;
            for(var i = 0;i<messageHistory.length;i++)
            {
              if(messageHistory[i].own)
              {
                  historyOwnMessage(messageHistory[i].message);
              }
              else
              {
                  //historyHostMessage(messageHistory[i].message);
              }
            }
          }

          //populateprevmessages();
          populatePage_hostName();
          updateRedirect();
    </script>

</body>
</html>
